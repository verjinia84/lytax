<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>세금 계산기</title>
    <!-- html2canvas 라이브러리 추가 -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2980b9;
            --background-color: #ecf0f1;
            --text-color: #34495e;
            --input-background: #fff;
            --result-background: #e8f4fd; /* 파스텔톤 하늘색 */
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 10px; /* 20px에서 10px로 줄임 */
            background-color: var(--background-color);
            color: var(--text-color);
            margin-left: 50px; /* 토글 버튼을 위한 공간 */
        }
        .calculator-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
        }
        .calculator {
            background-color: #fff;
            border-radius: 10px;
            padding: 15px; /* 20px에서 15px로 줄임 */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 350px;
            margin-bottom: 15px; /* 20px에서 15px로 줄임 */
        }
        h1 {
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 15px; /* 30px에서 15px로 줄임 */
            font-size: 24px; /* 제목 크기 줄임 */
        }
        label {
            display: block;
            margin: 10px 0 3px; /* 이전 설정 유지 */
            color: var(--secondary-color);
            font-weight: bold; /* 볼드 스타일 복원 */
        }
        input[type="text"], select {
            display: block;
            width: calc(100% - 20px);
            padding: 10px; /* 9px에서 10px로 증가 */
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            background-color: var(--input-background);
            color: var(--text-color);
            font-size: 14px; /* 13px에서 14px로 증가 */
            margin-bottom: 5px;
        }
        .result {
            margin-top: 15px; /* 20px에서 15px로 줄임 */
            padding: 10px; /* 15px에서 10px로 줄임 */
            background-color: var(--result-background);
            border-radius: 4px;
        }
        .result p {
            margin: 5px 0;
            font-weight: bold;
        }
        .buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 20px; /* 30px에서 20px로 줄임 */
        }
        button {
            padding: 10px 20px; /* 12px 24px에서 줄임 */
            border: none;
            border-radius: 4px;
            background-color: var(--primary-color);
            color: #fff;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.1s;
            font-size: 14px; /* 16px에서 14px로 줄임 */
            font-weight: bold;
        }
        button:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
        }
        button:active {
            transform: translateY(0);
        }
        @media (min-width: 768px) {
            .calculator {
                width: calc(50% - 20px);
            }
        }
        @media (min-width: 1024px) {
            .calculator {
                width: calc(25% - 15px); /* 33.33%에서 25%로 변경하여 한 줄에 4개 표시 */
            }
            #addCalculator, #resetAll {
                display: inline-block;
            }
        }
        @media (max-width: 1023px) {
            #addCalculator, #resetAll {
                display: none;
            }
        }
        .checkbox-container {
            display: flex;
            align-items: center;
            margin-top: 15px;
        }
        .checkbox-container input[type="checkbox"] {
            margin-right: 10px;
        }
        #calculatorType {
            margin-bottom: 20px;
            width: 100%;
            max-width: 350px;
        }
        /* 새로운 스타일 추가 */
        .calculator-type-buttons {
            display: flex;
            justify-content: center;
            margin-bottom: 15px; /* 20px에서 15px로 줄임 */
        }

        .calculator-type-button {
            padding: 8px 16px; /* 10px 20px에서 줄임 */
            margin: 0 10px;
            border: none;
            border-radius: 4px;
            background-color: var(--primary-color);
            color: #fff;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.1s;
            font-size: 14px; /* 16px에서 14px로 줄임 */
            font-weight: bold;
        }

        .calculator-type-button:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
        }

        .calculator-type-button:active {
            transform: translateY(0);
        }

        .calculator-type-button.active {
            background-color: var(--secondary-color);
        }

        /* 스크린샷 버튼 스타일 추가 */
        #screenshotButton {
            background-color: #27ae60;
            margin-left: 10px;
        }
        #screenshotButton:hover {
            background-color: #2ecc71;
        }
        .delete-button {
            background-color: #e74c3c;
            margin-top: 10px;
        }
        .delete-button:hover {
            background-color: #c0392b;
        }
        .total-tax {
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
            margin-top: 15px; /* 20px에서 15px로 줄임 */
            padding: 8px; /* 10px에서 8px로 줄임 */
            background-color: var(--result-background);
            border-radius: 4px;
        }
        
        /* 추가: 스크롤바 스타일 */
        body {
            max-height: 100vh;
            overflow-y: auto;
        }

        .result-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px; /* 8px에서 5px로 줄임 */
        }

        .result-label, .result-value {
            padding: 3px 0;
            font-weight: bold;
            font-size: 14px; /* 13px에서 14px로 증가 */
        }

        .gift-deduction-container {
            display: flex;
            flex-direction: column;
            gap: 5px; /* 10px에서 5px로 줄임 */
        }

        .gift-deduction-container select,
        .gift-deduction-container input {
            width: 100%;
            box-sizing: border-box;
            margin-bottom: 0; /* 하단 여백 제거 */
        }

        /* 직접 입력 칸의 스타일 수정 */
        .giftDeductionCustom {
            width: 100% !important;
            display: block;
            padding: 10px; /* 9px에서 10px로 증가 */
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            background-color: var(--input-background);
            color: var(--text-color);
            font-size: 14px; /* 13px에서 14px로 증가 */
            margin-top: 5px;
        }

        /* 전체적으로 위로 올리기 */
        .calculator-container {
            margin-top: -5px; /* -10px에서 -5px로 조정 */
        }

        /* 스크롤바 스타일 */
        body {
            scrollbar-width: thin;
            scrollbar-color: var(--secondary-color) var(--background-color);
        }

        body::-webkit-scrollbar {
            width: 8px;
        }

        body::-webkit-scrollbar-track {
            background: var(--background-color);
        }

        body::-webkit-scrollbar-thumb {
            background-color: var(--secondary-color);
            border-radius: 4px;
        }

        .history-panel {
            position: fixed;
            left: -250px;
            top: 0;
            width: 250px;
            height: 100%;
            background-color: #ffffff;
            transition: 0.3s;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }

        .history-panel.open {
            left: 0;
        }

        .toggle-history {
            position: fixed;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            writing-mode: vertical-rl;
            text-orientation: mixed;
            padding: 10px 5px;
            background-color: #3498db;
            color: white;
            border: none;
            cursor: pointer;
            z-index: 1001;
        }

        .history-content {
            padding: 20px;
        }

        .new-table-button {
            width: 100%;
            padding: 10px;
            margin-bottom: 20px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .history-item {
            margin-bottom: 10px;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-item h3 {
            margin: 0;
            flex-grow: 1;
            padding-right: 10px;
            font-size: 14px; /* 글자 크기를 줄임 */
        }

        .delete-history {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
        }

        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            background-color: #f9f9f9;
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
        }

        .dropdown:hover .dropdown-content {
            display: block;
        }

        .dropdown-content a {
            color: black;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
        }

        .dropdown-content a:hover {
            background-color: #f1f1f1;
        }

        body {
            margin-left: 50px; /* 토글 버튼을 위한 공간 */
        }

        .main-content {
            transition: margin-left 0.3s;
        }

        .history-panel {
            position: fixed;
            left: -250px;
            top: 0;
            width: 250px;
            height: 100%;
            background-color: #f1f1f1;
            transition: 0.3s;
            overflow-y: auto;
            z-index: 1000;
        }

        .history-panel.open {
            left: 0;
        }

        .toggle-history {
            position: fixed;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            writing-mode: vertical-rl;
            text-orientation: mixed;
            padding: 10px 5px;
            background-color: #3498db;
            color: white;
            border: none;
            cursor: pointer;
            z-index: 1001;
        }

        .history-content {
            padding: 20px;
        }

        .history-item {
            margin-bottom: 10px;
            padding: 10px;
            background-color: #fff;
            border-radius: 5px;
        }

        .history-item h3 {
            margin: 0;
            display: inline-block;
        }

        .delete-history {
            float: right;
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
        }

        .fee-center {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 300px;
        }

        /* 조정료 계산기 스타일 통일 */
        .calculator-fee {
            background-color: #fff;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 350px;
            margin-bottom: 15px;
        }
        .calculator-fee label {
            display: block;
            margin: 10px 0 3px;
            color: var(--secondary-color);
            font-weight: bold;
        }
        .calculator-fee input[type="text"], .calculator-fee select {
            display: block;
            width: calc(100% - 20px);
            padding: 10px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            background-color: var(--input-background);
            color: var(--text-color);
            font-size: 14px;
            margin-bottom: 5px;
        }
        .calculator-fee .result {
            margin-top: 15px;
            padding: 10px;
            background-color: var(--result-background);
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div id="historyPanel" class="history-panel">
        <button id="toggleHistory" class="toggle-history">히스토리</button>
        <div class="history-content">
            <button id="newTable" class="new-table-button">새 테이블</button>
            <div id="historyItems"></div>
        </div>
    </div>
    
    <div class="main-content">
        <h1>세금 계산기</h1>
        <div class="calculator-type-buttons">
            <button id="incomeButton" class="calculator-type-button active">2024년 종합소득세 계산기</button>
            <button id="giftButton" class="calculator-type-button">증여세 계산기</button>
            <button id="salaryButton" class="calculator-type-button">급여계산기</button>
            <button id="feeButton" class="calculator-type-button">조정료 계산기</button>
            <button id="screenshotButton" class="calculator-type-button">스크린샷</button>
        </div>
        <div id="incomeCalculatorSection" style="display:none;">
            <div class="calculator-container" id="calculatorContainer"></div>
            <div class="total-tax" id="totalTax"></div>
            <div class="buttons">
                <button id="addCalculator">계산기 추가</button>
                <button id="resetAll">모두 초기화</button>
            </div>
        </div>
        <div id="giftCalculatorSection" style="display:none;">
            <div class="calculator-container" id="giftCalculatorContainer"></div>
            <div class="total-tax" id="giftTotalTax"></div>
            <div class="buttons">
                <button id="addGiftCalculator">계산기 추가</button>
                <button id="resetGiftAll">모두 초기화</button>
            </div>
        </div>
        <div id="salaryCalculatorSection" style="display:none;">
            <div id="salaryCalcContainer"></div>
        </div>
        <div id="feeCalculatorSection" style="display:none;">
            <div class="calculator calculator-fee" id="feeCalcContainer">
                <h2>조정료 계산기</h2>
                <label>구분:</label>
                <select id="typeSelect"><option value="">선택</option></select>
                <label>업종:</label>
                <select id="bizSelect"><option value="">선택</option></select>
                <label>매출액(원):</label>
                <input type="text" id="amountInput" placeholder="매출액 입력">
                <label>가산 비율(%):</label>
                <input type="text" id="addRateInput" placeholder="가산 비율 입력">
                <label>직접입력 수수료(원):</label>
                <input type="text" id="addAmountInput" placeholder="직접입력 수수료 입력">
                <label>할인 금액(원):</label>
                <input type="text" id="discountInput" placeholder="할인 금액 입력">
                <div id="feeResult" class="result"></div>
            </div>
        </div>
        <div id="baseFeePreview" style="margin:6px 0 10px 0; color:#2980b9; font-weight:bold;"></div>
        <div id="salaryCalculatorModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.25); z-index:2000; align-items:center; justify-content:center;">
            <div style="background:#fff; border-radius:10px; max-width:800px; width:95vw; max-height:90vh; overflow:auto; box-shadow:0 4px 16px rgba(0,0,0,0.2); position:relative;">
                <button onclick="document.getElementById('salaryCalculatorModal').style.display='none'" style="position:absolute; top:10px; right:10px; background:#e74c3c; color:#fff; border:none; border-radius:4px; padding:4px 10px; cursor:pointer;">닫기</button>
                <iframe src="salary_calculator.html" style="width:100%; height:80vh; border:none; border-radius:10px;"></iframe>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
    // ------------------ 공통 유틸 ------------------
    function formatNumber(num) {
        return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }
    function unformatNumber(str) {
        return parseFloat((str || "0").toString().replace(/,/g, '')) || 0;
    }

    // ------------------ 종합소득세 계산기 ------------------
    function createIncomeCalculator() {
        const calculator = document.createElement('div');
        calculator.className = 'calculator';
        calculator.innerHTML = `
            <h2 contenteditable="true">2024년 종합소득세 계산</h2>
            <label>월 소득 (원):</label>
            <input type="text" class="monthlyIncome" placeholder="월 소득을 입력하세요">
            <label>곱할 개월 수:</label>
            <input type="text" class="monthMultiplier" value="12">
            <label>사업소득 (원):</label>
            <input type="text" class="businessIncome" placeholder="금액을 입력하세요">
            <label>소득공제 (원):</label>
            <input type="text" class="incomeDeduction" value="1,500,000">
            <div class="result">
                <div class="result-row">
                    <span class="result-label">과세표준:</span>
                    <span class="result-value"><span class="taxableIncome">0</span> 원</span>
                </div>
                <div class="result-row">
                    <span class="result-label">산출세액:</span>
                    <span class="result-value"><span class="calculatedTax">0</span> 원</span>
                </div>
                <div class="result-row">
                    <span class="result-label">한계세율:</span>
                    <span class="result-value"><span class="marginalTaxRate">0</span> %</span>
                </div>
            </div>
            <label>세액공제 (원):</label>
            <input type="text" class="taxCreditReduction" value="70,000">
            <div class="result">
                <div class="result-row">
                    <span class="result-label">최종 납부세액:</span>
                    <span class="result-value"><span class="finalTax">0</span> 원</span>
                </div>
                <div class="result-row">
                    <span class="result-label">최저한세:</span>
                    <span class="result-value"><span class="minimumTax">0</span> 원</span>
                </div>
                <div class="result-row">
                    <span class="result-label">추가 필요 세액공제:</span>
                    <span class="result-value"><span class="additionalTaxCredit">0</span> 원</span>
                </div>
            </div>
        `;
        calculator.querySelectorAll('input').forEach(input => {
            input.addEventListener('input', function() {
                updateInputFormat(this);
                if (this.classList.contains('monthlyIncome') || this.classList.contains('monthMultiplier')) {
                    calculateYearlyIncome(calculator);
                }
                calculateIncomeTax(calculator);
            });
        });
        return calculator;
    }
    function updateInputFormat(input) {
        let value = unformatNumber(input.value);
        input.value = formatNumber(value);
    }
    function calculateYearlyIncome(calculator) {
        const monthlyIncome = unformatNumber(calculator.querySelector('.monthlyIncome').value);
        const monthMultiplier = unformatNumber(calculator.querySelector('.monthMultiplier').value);
        const yearlyIncome = monthlyIncome * monthMultiplier;
        calculator.querySelector('.businessIncome').value = formatNumber(yearlyIncome);
    }
    function calculateIncomeTax(calculator) {
        const businessIncome = unformatNumber(calculator.querySelector('.businessIncome').value);
        const incomeDeduction = unformatNumber(calculator.querySelector('.incomeDeduction').value);
        const taxCreditReduction = unformatNumber(calculator.querySelector('.taxCreditReduction').value);
        const taxableIncome = Math.max(0, businessIncome - incomeDeduction);
        calculator.querySelector('.taxableIncome').innerText = formatNumber(taxableIncome);
        let calculatedTax = 0;
        if (taxableIncome <= 14000000) {
            calculatedTax = taxableIncome * 0.06;
        } else if (taxableIncome <= 50000000) {
            calculatedTax = 14000000 * 0.06 + (taxableIncome - 14000000) * 0.15;
        } else if (taxableIncome <= 88000000) {
            calculatedTax = 14000000 * 0.06 + 36000000 * 0.15 + (taxableIncome - 50000000) * 0.24;
        } else if (taxableIncome <= 150000000) {
            calculatedTax = 14000000 * 0.06 + 36000000 * 0.15 + 38000000 * 0.24 + (taxableIncome - 88000000) * 0.35;
        } else if (taxableIncome <= 300000000) {
            calculatedTax = 14000000 * 0.06 + 36000000 * 0.15 + 38000000 * 0.24 + 62000000 * 0.35 + (taxableIncome - 150000000) * 0.38;
        } else if (taxableIncome <= 500000000) {
            calculatedTax = 14000000 * 0.06 + 36000000 * 0.15 + 38000000 * 0.24 + 62000000 * 0.35 + 150000000 * 0.38 + (taxableIncome - 300000000) * 0.40;
        } else if (taxableIncome <= 1000000000) {
            calculatedTax = 14000000 * 0.06 + 36000000 * 0.15 + 38000000 * 0.24 + 62000000 * 0.35 + 150000000 * 0.38 + 200000000 * 0.40 + (taxableIncome - 500000000) * 0.42;
        } else {
            calculatedTax = 14000000 * 0.06 + 36000000 * 0.15 + 38000000 * 0.24 + 62000000 * 0.35 + 150000000 * 0.38 + 200000000 * 0.40 + 500000000 * 0.42 + (taxableIncome - 1000000000) * 0.45;
        }
        calculator.querySelector('.calculatedTax').innerText = formatNumber(Math.round(calculatedTax));
        const finalTax = Math.max(0, calculatedTax - taxCreditReduction);
        calculator.querySelector('.finalTax').innerText = formatNumber(Math.round(finalTax));
        let minimumTax = 0;
        if (calculatedTax <= 30000000) {
            minimumTax = calculatedTax * 0.35;
        } else {
            minimumTax = 30000000 * 0.35 + (calculatedTax - 30000000) * 0.45;
        }
        calculator.querySelector('.minimumTax').innerText = formatNumber(Math.round(minimumTax));
        const additionalTaxCredit = Math.max(0, finalTax - minimumTax);
        calculator.querySelector('.additionalTaxCredit').innerText = formatNumber(Math.round(additionalTaxCredit));
        let marginalTaxRate = 0;
        if (taxableIncome <= 14000000) marginalTaxRate = 6;
        else if (taxableIncome <= 50000000) marginalTaxRate = 15;
        else if (taxableIncome <= 88000000) marginalTaxRate = 24;
        else if (taxableIncome <= 150000000) marginalTaxRate = 35;
        else if (taxableIncome <= 300000000) marginalTaxRate = 38;
        else if (taxableIncome <= 500000000) marginalTaxRate = 40;
        else if (taxableIncome <= 1000000000) marginalTaxRate = 42;
        else marginalTaxRate = 45;
        calculator.querySelector('.marginalTaxRate').innerText = marginalTaxRate;
    }

    // ------------------ 증여세 계산기 ------------------
    function createGiftCalculator() {
        const calculator = document.createElement('div');
        calculator.className = 'calculator';
        const uniqueId = 'generationSkipping_' + Date.now() + Math.floor(Math.random()*1000);
        calculator.innerHTML = `
            <h2 contenteditable="true">증여세 계산</h2>
            <label>증여재산가액 (원):</label>
            <input type="text" class="giftAmount" placeholder="증여재산가액을 입력하세요">
            <label>사전증여재산 (원):</label>
            <input type="text" class="previousGift" placeholder="사전증여재산을 입력하세요">
            <label>증여재산공제 (원):</label>
            <div class="gift-deduction-container">
                <select class="giftDeduction">
                    <option value="10000000">10,000,000</option>
                    <option value="20000000">20,000,000</option>
                    <option value="50000000">50,000,000</option>
                    <option value="600000000">600,000,000</option>
                </select>
                <input type="text" class="giftDeductionCustom" placeholder="직접 입력">
            </div>
            <div class="checkbox-container">
                <input type="checkbox" id="${uniqueId}" class="generationSkipping">
                <label for="${uniqueId}">세대할증</label>
            </div>
            <div class="result">
                <div class="result-row">
                    <span class="result-label">증여세 과세표준:</span>
                    <span class="result-value"><span class="taxableGift">0</span> 원</span>
                </div>
                <div class="result-row">
                    <span class="result-label">산출세액:</span>
                    <span class="result-value"><span class="calculatedTax">0</span> 원</span>
                </div>
                <div class="result-row">
                    <span class="result-label">한계세율:</span>
                    <span class="result-value"><span class="marginalTaxRate">0</span> %</span>
                </div>
            </div>
            <div class="result">
                <div class="result-row">
                    <span class="result-label">신고세액공제:</span>
                    <span class="result-value"><span class="taxCreditReduction">0</span> 원</span>
                </div>
                <div class="result-row">
                    <span class="result-label">최종 납부세액:</span>
                    <span class="result-value"><span class="finalTax">0</span> 원</span>
                </div>
            </div>
            <button class="delete-button">삭제</button>
        `;
        calculator.querySelectorAll('input, select').forEach(input => {
            input.addEventListener('input', function() {
                if (this.type === 'text') updateInputFormat(this);
                calculateGiftTax(calculator);
            });
        });
        calculator.querySelector('.generationSkipping').addEventListener('change', function() {
            calculateGiftTax(calculator);
        });
        calculator.querySelector('label[for^="generationSkipping_"]').addEventListener('click', function() {
            setTimeout(() => calculateGiftTax(calculator), 0);
        });
        calculator.querySelector('.delete-button').addEventListener('click', function() {
            calculator.remove();
            updateTotalTax();
        });
        return calculator;
    }
    function calculateGiftTax(calculator) {
        const giftAmount = unformatNumber(calculator.querySelector('.giftAmount').value);
        const previousGift = unformatNumber(calculator.querySelector('.previousGift').value);
        let giftDeduction = unformatNumber(calculator.querySelector('.giftDeduction').value);
        const customDeduction = unformatNumber(calculator.querySelector('.giftDeductionCustom').value);
        const isGenerationSkipping = calculator.querySelector('.generationSkipping').checked;
        if (calculator.querySelector('.giftDeductionCustom').value !== '') {
            giftDeduction = customDeduction;
        }
        const taxableGift = Math.max(0, giftAmount + previousGift - giftDeduction);
        calculator.querySelector('.taxableGift').innerText = formatNumber(taxableGift);
        let calculatedTax = 0;
        if (taxableGift <= 100000000) {
            calculatedTax = taxableGift * 0.10;
        } else if (taxableGift <= 500000000) {
            calculatedTax = 10000000 + (taxableGift - 100000000) * 0.20;
        } else if (taxableGift <= 1000000000) {
            calculatedTax = 90000000 + (taxableGift - 500000000) * 0.30;
        } else if (taxableGift <= 3000000000) {
            calculatedTax = 240000000 + (taxableGift - 1000000000) * 0.40;
        } else {
            calculatedTax = 1040000000 + (taxableGift - 3000000000) * 0.50;
        }
        if (isGenerationSkipping) calculatedTax *= 1.3;
        calculator.querySelector('.calculatedTax').innerText = formatNumber(Math.round(calculatedTax));
        const taxCreditReduction = calculatedTax * 0.03;
        calculator.querySelector('.taxCreditReduction').innerText = formatNumber(Math.round(taxCreditReduction));
        const finalTax = Math.max(0, calculatedTax - taxCreditReduction);
        calculator.querySelector('.finalTax').innerText = formatNumber(Math.round(finalTax));
        let marginalTaxRate = 0;
        if (taxableGift <= 100000000) marginalTaxRate = 10;
        else if (taxableGift <= 500000000) marginalTaxRate = 20;
        else if (taxableGift <= 1000000000) marginalTaxRate = 30;
        else if (taxableGift <= 3000000000) marginalTaxRate = 40;
        else marginalTaxRate = 50;
        if (isGenerationSkipping) marginalTaxRate = Math.min(marginalTaxRate * 1.3, 50);
        calculator.querySelector('.marginalTaxRate').innerText = marginalTaxRate;
        updateTotalTax();
    }
    function updateTotalTax() {
        const calculators = document.querySelectorAll('.calculator-container .calculator');
        let totalTax = 0;
        calculators.forEach(calc => {
            const finalTaxElement = calc.querySelector('.finalTax');
            if (finalTaxElement) {
                totalTax += unformatNumber(finalTaxElement.innerText);
            }
        });
        document.getElementById('totalTax').innerText = `총 부담세액: ${formatNumber(Math.round(totalTax))} 원`;
    }

    // ------------------ 조정료(수수료) 계산기 ------------------
    let rateTable = {};
    async function loadRateTable() {
        try {
            const res = await fetch('rate_table.csv');
            const text = await res.text();
            const lines = text.split('\n').map(l => l.trim()).filter(l => l);
            let isHeader = true;
            for (let line of lines) {
                if (isHeader) { isHeader = false; continue; }
                const [구분, 업종, 수입금액, 요율, 베이스, 추가분, 합계] = line.split(',').map(x => (x||'').trim());
                if (!rateTable[구분]) rateTable[구분] = {};
                if (!rateTable[구분][업종]) rateTable[구분][업종] = [];
                rateTable[구분][업종].push({
                    수입금액: Number((수입금액||'').replace(/[^0-9]/g, '') || 0),
                    요율: parseFloat((요율||'').replace('%','')) || 0,
                    베이스: Number((베이스||'').replace(/[^0-9]/g, '') || 0),
                    추가분: Number((추가분||'').replace(/[^0-9]/g, '') || 0),
                    합계: Number((합계||'').replace(/[^0-9]/g, '') || 0)
                });
            }
            for (const type in rateTable) {
                for (const biz in rateTable[type]) {
                    rateTable[type][biz].sort((a, b) => a.수입금액 - b.수입금액);
                }
            }
        } catch (e) {
            document.getElementById('feeResult').innerHTML = '요율표.csv를 불러올 수 없습니다.';
        }
    }
    function formatNumberWithCommas(x) {
        if (typeof x === 'number') x = x.toString();
        return x.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }
    function calcFee() {
        const type = document.getElementById('typeSelect').value.trim();
        const biz = document.getElementById('bizSelect').value.trim();
        let amountRaw = document.getElementById('amountInput').value.replace(/[^\d]/g, '');
        let amount = Number(amountRaw);
        let addRate = parseFloat(document.getElementById('addRateInput').value.replace(/[^\d.\-]/g, '')) || 0;
        let addAmount = Number(document.getElementById('addAmountInput').value.replace(/[^\d]/g, '')) || 0;
        let discount = Number(document.getElementById('discountInput').value.replace(/[^\d]/g, '')) || 0;

        if (!rateTable[type] || !rateTable[type][biz]) {
            document.getElementById('feeResult').innerHTML = '요율표 정보가 없습니다.';
            return;
        }
        if (!amount) {
            document.getElementById('feeResult').innerHTML = '매출액을 입력하세요.';
            return;
        }
        let rows = rateTable[type][biz];
        let idx = 0;
        for (let i = 0; i < rows.length; i++) {
            if (amount >= rows[i].수입금액) idx = i;
            else break;
        }
        let row = rows[idx];
        let baseAmount = row.수입금액;
        let fee = row.베이스 + (amount - baseAmount) * (row.요율 / 100);
        fee = Math.round(fee/10)*10;
        let addRateFee = Math.round(fee * (addRate/100)/10)*10;
        let totalFee = fee + addRateFee + addAmount - discount;
        let penalty = Math.round(totalFee * 0.1/10)*10;
        let totalCharge = totalFee + penalty;
        const formula = `${row.베이스.toLocaleString()} + (${amount.toLocaleString()} - ${baseAmount.toLocaleString()}) × ${row.요율.toFixed(2)}%`;

        document.getElementById('feeResult').innerHTML =
            `<div>매출액 기준 수수료: <b>${fee.toLocaleString()}원</b></div>`+
            `<div>가산 비율 수수료: <b>${addRateFee.toLocaleString()}원</b></div>`+
            `<div>직접입력 수수료: <b>${addAmount.toLocaleString()}원</b></div>`+
            `<div style="color:#e74c3c;">할인 금액: <b>${discount.toLocaleString()}원</b></div>`+
            `<div style='margin-top:8px;'>총 수수료 금액: <b>${totalFee.toLocaleString()}원</b></div>`+
            `<div>10% 가산세: <b>${penalty.toLocaleString()}원</b></div>`+
            `<div style='font-size:1.1em;margin-top:8px;'>총 청구금액: <b>${totalCharge.toLocaleString()}원</b></div>`+
            `<div style='font-size:13px;color:#888;margin-top:8px;'>계산식: (${formula}) + (${addRate}% 가산) + ${addAmount.toLocaleString()} - ${discount.toLocaleString()} + 10% 가산세</div>`;
    }

    // ------------------ 탭 전환 및 이벤트 ------------------
    function showSection(section) {
        document.getElementById('incomeCalculatorSection').style.display = (section === 'income') ? 'block' : 'none';
        document.getElementById('giftCalculatorSection').style.display = (section === 'gift') ? 'block' : 'none';
        document.getElementById('salaryCalculatorSection').style.display = (section === 'salary') ? 'block' : 'none';
        document.getElementById('feeCalculatorSection').style.display = (section === 'fee') ? 'block' : 'none';
        document.getElementById('incomeButton').classList.toggle('active', section === 'income');
        document.getElementById('giftButton').classList.toggle('active', section === 'gift');
        document.getElementById('salaryButton').classList.toggle('active', section === 'salary');
        document.getElementById('feeButton').classList.toggle('active', section === 'fee');
        if (section === 'income') {
            const container = document.getElementById('calculatorContainer');
            container.innerHTML = '';
            container.appendChild(createIncomeCalculator());
            document.getElementById('totalTax').style.display = 'none';
        } else if (section === 'gift') {
            const container = document.getElementById('giftCalculatorContainer');
            container.innerHTML = '';
            container.appendChild(createGiftCalculator());
            document.getElementById('giftTotalTax').style.display = 'block';
        } else if (section === 'salary') {
            // 급여계산기: salary_calculator.html의 스타일, HTML, JS를 완전히 동일하게 동적 삽입
            const container = document.getElementById('salaryCalcContainer');
            // 스타일 중복 방지
            if (!document.getElementById('salaryCalcStyle')) {
                const style = document.createElement('style');
                style.id = 'salaryCalcStyle';
                style.innerHTML = `
                :root { --primary-color: #3498db; --secondary-color: #2980b9; --background-color: #ecf0f1; --text-color: #34495e; --input-background: #fff; --result-background: #e8f4fd; }
                #salaryCalcContainer { max-width: 700px; margin: 30px auto; background: #fff; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); padding: 24px; }
                #salaryCalcContainer h1 { text-align: center; color: var(--primary-color); margin-bottom: 20px; }
                #salaryCalcContainer .input-row { display: flex; align-items: flex-end; gap: 10px; margin-bottom: 8px; }
                #salaryCalcContainer .input-row label.title-label { margin: 0; color: var(--secondary-color); font-weight: bold; font-size: 14px; min-width: 140px; }
                #salaryCalcContainer .input-row input[type="text"] { flex: 1; min-width: 0; }
                #salaryCalcContainer .input-row .ai-btn { margin-left: 0; }
                #salaryCalcContainer .toggle-col { display: flex; flex-direction: column; align-items: center; min-width: 70px; }
                #salaryCalcContainer .toggle-label { font-size: 12px; color: var(--secondary-color); font-weight: bold; margin-bottom: 2px; text-align: center; }
                #salaryCalcContainer .switch { position: relative; display: inline-block; width: 44px; height: 24px; vertical-align: middle; }
                #salaryCalcContainer .switch input { opacity: 0; width: 0; height: 0; }
                #salaryCalcContainer .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .3s; border-radius: 24px; }
                #salaryCalcContainer .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .3s; border-radius: 50%; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
                #salaryCalcContainer .switch input:checked + .slider { background-color: var(--primary-color); }
                #salaryCalcContainer .switch input:checked + .slider:before { transform: translateX(20px); }
                #salaryCalcContainer .form-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px 12px; margin-bottom: 10px; }
                #salaryCalcContainer .form-grid > div { display: flex; flex-direction: column; }
                #salaryCalcContainer label { display: block; margin: 6px 0 2px; color: var(--secondary-color); font-weight: bold; font-size: 13px; }
                #salaryCalcContainer input[type="text"], #salaryCalcContainer input[type="number"] { width: 100%; padding: 6px 8px; border: 1px solid #bdc3c7; border-radius: 4px; background-color: var(--input-background); color: var(--text-color); font-size: 13px; margin-bottom: 0; box-sizing: border-box; }
                #salaryCalcContainer .result { margin-top: 20px; padding: 12px; background-color: var(--result-background); border-radius: 4px; }
                #salaryCalcContainer .result p { margin: 5px 0; font-weight: bold; white-space: pre-line; }
                #salaryCalcContainer .buttons { display: flex; justify-content: space-between; margin-top: 20px; }
                #salaryCalcContainer button { padding: 8px 16px; border: none; border-radius: 4px; background-color: var(--primary-color); color: #fff; cursor: pointer; transition: background-color 0.3s, transform 0.1s; font-size: 13px; font-weight: bold; }
                #salaryCalcContainer button:hover { background-color: var(--secondary-color); transform: translateY(-2px); }
                #salaryCalcContainer button:active { transform: translateY(0); }
                #salaryCalcContainer .formula { background: #f9f9f9; border-radius: 4px; padding: 8px; margin-top: 10px; font-size: 13px; color: #555; }
                #salaryCalcContainer .json-view { background: #f4f4f4; border-radius: 4px; padding: 8px; font-size: 12px; margin-top: 10px; color: #888; word-break: break-all; }
                @media (max-width: 500px) { #salaryCalcContainer .form-grid { grid-template-columns: 1fr 1fr; } #salaryCalcContainer .input-row { flex-direction: column; align-items: stretch; gap: 4px; } #salaryCalcContainer .toggle-col { flex-direction: row; align-items: center; min-width: 0; } #salaryCalcContainer .toggle-label { margin-bottom: 0; margin-right: 8px; } }
                @media (max-width: 350px) { #salaryCalcContainer .form-grid { grid-template-columns: 1fr; } }
                `;
                document.head.appendChild(style);
            }
            // HTML 삽입
            container.innerHTML = `
                <h1>AI 급여 계산기</h1>
                <div class="input-row">
                    <label class="title-label" for="naturalInput">자연어로 근로조건 입력:</label>
                    <input type="text" id="naturalInput" placeholder="예: 주 5일, 하루 9시간, 시급 12000원, 야간근무 있음, 5인 이상 사업장...">
                    <button class="ai-btn" id="aiAnalyzeBtn">AI로 해석 및 계산</button>
                    <div class="toggle-col">
                        <span class="toggle-label">5인 이상 사업장</span>
                        <label class="switch" title="5인 이상 사업장">
                            <input type="checkbox" id="over5Employees" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                <div class="json-view" id="jsonView" style="display:none;"></div>
                <form id="salaryForm" style="margin-top:14px;">
                    <div class="form-grid">
                        <div><label>시급(원): <input type="text" id="hourlyWage" value="10,030"></label></div>
                        <div><label>주 근로일수: <input type="text" id="daysPerWeek" value="5"></label></div>
                        <div><label>하루 근로시간: <input type="text" id="hoursPerDay" value="8"></label></div>
                        <div><label>주간 총 근로시간: <input type="text" id="totalHoursPerWeek" value="40"></label></div>
                        <div><label>연장 근로시간(주): <input type="text" id="overtimeHours" value="0"></label></div>
                        <div><label>야간 근로시간(주): <input type="text" id="nightHours" value="0"></label></div>
                        <div><label>휴일 근로시간(주): <input type="text" id="holidayHours" value="0"></label></div>
                        <div><label>휴게시간(주): <input type="text" id="breakHours" value="0"></label></div>
                        <div><label>목표 월급(원): <input type="text" id="targetSalary" value=""></label></div>
                    </div>
                    <button type="button" id="salaryCalcBtn2">월급 계산</button>
                </form>
                <div class="result" id="salaryResult" style="display:none;"></div>
                <div class="formula" id="formulaView" style="display:none;"></div>
            `;
            // JS 삽입 (즉시실행)
            (function(){
            function addComma(num) {
                if (num === null || num === undefined || num === '') return '';
                let n = String(num).replace(/[^\d.-]/g, '');
                if (n === '') return '';
                let parts = n.split('.');
                parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                return parts.join('.');
            }
            function removeComma(str) {
                return str.replace(/,/g, '');
            }
            const inputConfigs = [
                {id:'hourlyWage', step:10, min:0},
                {id:'daysPerWeek', step:1, min:1, max:7},
                {id:'hoursPerDay', step:0.5, min:0, max:24},
                {id:'totalHoursPerWeek', step:0.5, min:0, max:168},
                {id:'overtimeHours', step:0.5, min:0, max:168},
                {id:'nightHours', step:0.5, min:0, max:168},
                {id:'holidayHours', step:0.5, min:0, max:168},
                {id:'breakHours', step:0.5, min:0, max:168},
                {id:'targetSalary', step:1000, min:0}
            ];
            inputConfigs.forEach(cfg => {
                const el = document.getElementById(cfg.id);
                if (el) {
                    el.addEventListener('input', function(e) {
                        let val = removeComma(this.value);
                        if (val && !isNaN(val)) {
                            this.value = addComma(val);
                        } else {
                            this.value = '';
                        }
                        calculateSalary();
                    });
                    const wrapper = document.createElement('div');
                    wrapper.style.position = 'relative';
                    wrapper.style.display = 'flex';
                    wrapper.style.alignItems = 'center';
                    el.parentNode.insertBefore(wrapper, el);
                    wrapper.appendChild(el);
                    const upBtn = document.createElement('button');
                    upBtn.type = 'button';
                    upBtn.innerHTML = '▲';
                    upBtn.style.position = 'absolute';
                    upBtn.style.right = '0';
                    upBtn.style.top = '0';
                    upBtn.style.width = '22px';
                    upBtn.style.height = '16px';
                    upBtn.style.fontSize = '10px';
                    upBtn.style.padding = '0';
                    upBtn.style.background = '#eee';
                    upBtn.style.border = '1px solid #ccc';
                    upBtn.style.borderRadius = '0 4px 0 0';
                    upBtn.style.cursor = 'pointer';
                    upBtn.tabIndex = -1;
                    const downBtn = document.createElement('button');
                    downBtn.type = 'button';
                    downBtn.innerHTML = '▼';
                    downBtn.style.position = 'absolute';
                    downBtn.style.right = '0';
                    downBtn.style.bottom = '0';
                    downBtn.style.width = '22px';
                    downBtn.style.height = '16px';
                    downBtn.style.fontSize = '10px';
                    downBtn.style.padding = '0';
                    downBtn.style.background = '#eee';
                    downBtn.style.border = '1px solid #ccc';
                    downBtn.style.borderRadius = '0 0 4px 0';
                    downBtn.style.cursor = 'pointer';
                    downBtn.tabIndex = -1;
                    wrapper.appendChild(upBtn);
                    wrapper.appendChild(downBtn);
                    upBtn.addEventListener('click', function() {
                        let val = parseFloat(removeComma(el.value)) || 0;
                        val += cfg.step;
                        if (cfg.max !== undefined && val > cfg.max) val = cfg.max;
                        if (cfg.min !== undefined && val < cfg.min) val = cfg.min;
                        el.value = addComma(val);
                        el.dispatchEvent(new Event('input', { bubbles: true }));
                    });
                    downBtn.addEventListener('click', function() {
                        let val = parseFloat(removeComma(el.value)) || 0;
                        val -= cfg.step;
                        if (cfg.max !== undefined && val > cfg.max) val = cfg.max;
                        if (cfg.min !== undefined && val < cfg.min) val = cfg.min;
                        el.value = addComma(val);
                        el.dispatchEvent(new Event('input', { bubbles: true }));
                    });
                }
            });
            document.getElementById('over5Employees').addEventListener('change', calculateSalary);
            document.getElementById('naturalInput').addEventListener('input', function(){
                document.getElementById('jsonView').style.display = 'none';
            });
            const manualInput = {
                totalHoursPerWeek: false,
                overtimeHours: false,
                nightHours: false
            };
            ['totalHoursPerWeek', 'overtimeHours', 'nightHours'].forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('input', (e) => {
                        if (e.isTrusted) manualInput[id] = true;
                    });
                }
            });
            ['daysPerWeek', 'hoursPerDay'].forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('input', function() {
                        const days = Number(removeComma(document.getElementById('daysPerWeek').value)) || 0;
                        const hours = Number(removeComma(document.getElementById('hoursPerDay').value)) || 0;
                        const total = days * hours;
                        if (!manualInput.totalHoursPerWeek) {
                            const totalEl = document.getElementById('totalHoursPerWeek');
                            if (totalEl) {
                                totalEl.value = addComma(total);
                                totalEl.dispatchEvent(new Event('input', { bubbles: true }));
                            }
                        }
                        let night = 0;
                        for (let h = 0; h < hours; h++) {
                            let hour = (9 + h) % 24;
                            if (hour >= 22 || hour < 6) night++;
                        }
                        night = night * days;
                        if (!manualInput.nightHours) {
                            const nightEl = document.getElementById('nightHours');
                            if (nightEl) {
                                nightEl.value = addComma(night);
                                nightEl.dispatchEvent(new Event('input', { bubbles: true }));
                            }
                        }
                        let over8 = Math.max(0, (hours - 8) * days);
                        let over40 = Math.max(0, total - 40);
                        let overtime = Math.max(over8, over40);
                        if (!manualInput.overtimeHours) {
                            const overEl = document.getElementById('overtimeHours');
                            if (overEl) {
                                overEl.value = addComma(overtime);
                                overEl.dispatchEvent(new Event('input', { bubbles: true }));
                            }
                        }
                    });
                }
            });
            document.getElementById('aiAnalyzeBtn').addEventListener('click', analyzeInput);
            document.getElementById('salaryCalcBtn2').addEventListener('click', calculateSalary);
            async function analyzeInput() {
                const input = document.getElementById('naturalInput').value;
                if (!input.trim()) {
                    alert('근로조건을 입력하세요.');
                    return;
                }
                document.getElementById('jsonView').style.display = 'block';
                document.getElementById('jsonView').innerText = 'GPT 호출 중...';
                const prompt = `아래의 근로조건을 급여 계산에 필요한 json 형태로 변환해줘.\n- 야간근로시간(주): 22시~06시 사이의 근로시간을 모두 합산해서 계산해줘.\n- 연장근로시간(주): 하루 8시간 초과분, 주 40시간 초과분 중 큰 값을 계산해서 넣어줘.\n조건: ${input}\n\njson 예시:\n{\n  "hourlyWage": 10030,\n  "daysPerWeek": 5,\n  "hoursPerDay": 15,\n  "totalHoursPerWeek": 75,\n  "nightHours": 15,\n  "overtimeHours": 35,\n  "holidayHours": 0,\n  "breakHours": 0,\n  "over5Employees": true,\n  "targetSalary": null\n}`;
                const res = await fetch('/api/gpt', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: 'gpt-4.1',
                        messages: [{role: 'user', content: prompt}],
                        max_tokens: 512,
                        temperature: 0.2
                    })
                });
                let jsonText = await res.json();
                jsonText = jsonText.choices[0].message.content;
                try {
                    jsonText = jsonText.match(/\{[\s\S]*\}/)[0];
                    const jsonObj = JSON.parse(jsonText);
                    document.getElementById('jsonView').style.display = 'block';
                    document.getElementById('jsonView').innerText = jsonText;
                    let autoNight = 0, autoOver = 0;
                    if (jsonObj.hoursPerDay && jsonObj.daysPerWeek) {
                        let start = 9;
                        let end = 9 + Number(jsonObj.hoursPerDay);
                        for (let h = 0; h < Number(jsonObj.hoursPerDay); h++) {
                            let hour = (start + h) % 24;
                            if (hour >= 22 || hour < 6) autoNight++;
                        }
                        autoNight = autoNight * Number(jsonObj.daysPerWeek);
                        let over8 = Math.max(0, (Number(jsonObj.hoursPerDay) - 8) * Number(jsonObj.daysPerWeek));
                        let over40 = Math.max(0, Number(jsonObj.totalHoursPerWeek || (jsonObj.hoursPerDay * jsonObj.daysPerWeek)) - 40);
                        autoOver = Math.max(over8, over40);
                    }
                    for (const key in jsonObj) {
                        const el = document.getElementById(key);
                        if (el) {
                            if (typeof jsonObj[key] === 'boolean') {
                                el.checked = jsonObj[key];
                            } else {
                                let v = jsonObj[key];
                                if (key === 'nightHours' && (!v || v === 0) && autoNight > 0) v = autoNight;
                                if (key === 'overtimeHours' && (!v || v === 0) && autoOver > 0) v = autoOver;
                                el.value = addComma(v);
                                el.dispatchEvent(new Event('input', { bubbles: true }));
                            }
                        }
                    }
                    if (!('nightHours' in jsonObj) && autoNight > 0) {
                        const el = document.getElementById('nightHours');
                        if (el) {
                            el.value = addComma(autoNight);
                            el.dispatchEvent(new Event('input', { bubbles: true }));
                        }
                    }
                    if (!('overtimeHours' in jsonObj) && autoOver > 0) {
                        const el = document.getElementById('overtimeHours');
                        if (el) {
                            el.value = addComma(autoOver);
                            el.dispatchEvent(new Event('input', { bubbles: true }));
                        }
                    }
                    calculateSalary();
                    manualInput.totalHoursPerWeek = false;
                    manualInput.overtimeHours = false;
                    manualInput.nightHours = false;
                } catch (e) {
                    document.getElementById('jsonView').style.display = 'block';
                    document.getElementById('jsonView').innerText = 'JSON 파싱 실패: ' + (jsonText || '');
                }
            }
            function calculateSalary() {
                let hourlyWage = Number(removeComma(document.getElementById('hourlyWage').value)) || 10030;
                let daysPerWeek = Number(removeComma(document.getElementById('daysPerWeek').value)) || 5;
                let hoursPerDay = Number(removeComma(document.getElementById('hoursPerDay').value)) || 8;
                let totalHoursPerWeek = Number(removeComma(document.getElementById('totalHoursPerWeek').value)) || (daysPerWeek * hoursPerDay);
                let overtimeHoursInput = Number(removeComma(document.getElementById('overtimeHours').value)) || 0;
                let nightHours = Number(removeComma(document.getElementById('nightHours').value)) || 0;
                let holidayHours = Number(removeComma(document.getElementById('holidayHours').value)) || 0;
                let breakHours = Number(removeComma(document.getElementById('breakHours').value)) || 0;
                let over5Employees = document.getElementById('over5Employees').checked;
                let targetSalary = Number(removeComma(document.getElementById('targetSalary').value)) || null;
                let baseHours = totalHoursPerWeek - breakHours;
                let basePay = baseHours * hourlyWage;
                let over8 = Math.max(0, (hoursPerDay - 8) * daysPerWeek);
                let over40 = Math.max(0, totalHoursPerWeek - 40);
                let overtimeHours = overtimeHoursInput > 0 ? overtimeHoursInput : Math.max(over8, over40);
                let overtimeRate = over5Employees ? 1.5 : 1.0;
                let nightRate = over5Employees ? 1.5 : 1.0;
                let holidayRate = over5Employees ? 1.5 : 1.0;
                let overtimePay = overtimeHours * hourlyWage * (overtimeRate - 1);
                let nightPay = nightHours * hourlyWage * (nightRate - 1);
                let holidayPay = holidayHours * hourlyWage * (holidayRate - 1);
                let weeklyPay = (basePay + overtimePay + nightPay + holidayPay);
                let monthlyPay = weeklyPay * 4.345;
                let calculatedHourly = null;
                if (targetSalary) {
                    calculatedHourly = Math.round(targetSalary / (baseHours * 4.345));
                }
                let resultHtml = `<p>월급: <b>${addComma(Math.round(monthlyPay))} 원</b></p>`;
                resultHtml += `<p>주급: ${addComma(Math.round(weeklyPay))} 원</p>`;
                resultHtml += `<p>기본근로시간(주): ${addComma(baseHours)}시간\n연장근로시간(주): ${addComma(overtimeHours)}시간\n야간근로(주): ${addComma(nightHours)}시간\n휴일근로(주): ${addComma(holidayHours)}시간</p>`;
                resultHtml += `<p>연장수당: ${addComma(Math.round(overtimePay * 4.345))}원\n야간수당: ${addComma(Math.round(nightPay * 4.345))}원\n휴일수당: ${addComma(Math.round(holidayPay * 4.345))}원</p>`;
                if (calculatedHourly) {
                    resultHtml += `<p>목표 월급에 필요한 시급: <b>${addComma(calculatedHourly)} 원</b></p>`;
                }
                document.getElementById('salaryResult').style.display = 'block';
                document.getElementById('salaryResult').innerHTML = resultHtml;
                let formula = `월급 = ( (기본근로 ${addComma(baseHours)}h × 시급 ${addComma(hourlyWage)}) + (연장근로 ${addComma(overtimeHours)}h × 시급 × ${overtimeRate-1}) + (야간근로 ${addComma(nightHours)}h × 시급 × ${nightRate-1}) + (휴일근로 ${addComma(holidayHours)}h × 시급 × ${holidayRate-1}) ) × 4.345`;
                document.getElementById('formulaView').style.display = 'block';
                document.getElementById('formulaView').innerText = formula;
            }
            calculateSalary();
            })();
        } else if (section === 'fee') {
            // 조정료 계산기는 이미 feeCalcContainer에 UI가 있으므로 별도 초기화 불필요
        }
    }
    function switchCalculatorType(type) {
        const container = document.getElementById('calculatorContainer');
        if (type === 'income') {
            container.innerHTML = '';
            container.appendChild(createIncomeCalculator());
            document.getElementById('totalTax').style.display = 'none';
        } else {
            container.innerHTML = '';
            container.appendChild(createGiftCalculator());
            document.getElementById('totalTax').style.display = 'block';
        }
        updateTotalTax();
    }
    function addCalculator() {
        const container = document.getElementById('calculatorContainer');
        const activeButton = document.querySelector('.calculator-type-button.active');
        const calculatorType = activeButton.id === 'incomeButton' ? 'income' : 'gift';
        if (calculatorType === 'income') {
            container.appendChild(createIncomeCalculator());
        } else {
            container.appendChild(createGiftCalculator());
            updateTotalTax();
        }
    }
    function resetAll() {
        const activeButton = document.querySelector('.calculator-type-button.active');
        const calculatorType = activeButton.id === 'incomeButton' ? 'income' : 'gift';
        switchCalculatorType(calculatorType);
    }

    function previewBaseFee() {
        const type = document.getElementById('typeSelect').value.trim();
        const biz = document.getElementById('bizSelect').value.trim();
        let amountRaw = document.getElementById('amountInput').value.replace(/[^\d]/g, '');
        let amount = Number(amountRaw);
        if (!rateTable[type] || !rateTable[type][biz] || !amount) {
            document.getElementById('baseFeePreview').innerText = '';
            return;
        }
        let rows = rateTable[type][biz];
        let idx = 0;
        for (let i = 0; i < rows.length; i++) {
            if (amount >= rows[i].수입금액) idx = i;
            else break;
        }
        let row = rows[idx];
        let baseAmount = row.수입금액;
        let fee = row.베이스 + (amount - baseAmount) * (row.요율 / 100);
        fee = Math.round(fee/10)*10;
        document.getElementById('baseFeePreview').innerText = `매출액 기준 수수료: ${fee.toLocaleString()}원`;
    }

    document.addEventListener('DOMContentLoaded', function() {
        loadRateTable();
        document.getElementById('incomeButton').addEventListener('click', () => showSection('income'));
        document.getElementById('giftButton').addEventListener('click', () => showSection('gift'));
        document.getElementById('salaryButton').addEventListener('click', () => showSection('salary'));
        document.getElementById('feeButton').addEventListener('click', () => showSection('fee'));
        document.getElementById('addCalculator').addEventListener('click', function() {
            const container = document.getElementById('calculatorContainer');
            container.appendChild(createIncomeCalculator());
        });
        document.getElementById('resetAll').addEventListener('click', function() {
            const container = document.getElementById('calculatorContainer');
            container.innerHTML = '';
            container.appendChild(createIncomeCalculator());
        });
        document.getElementById('addGiftCalculator').addEventListener('click', function() {
            const container = document.getElementById('giftCalculatorContainer');
            container.appendChild(createGiftCalculator());
        });
        document.getElementById('resetGiftAll').addEventListener('click', function() {
            const container = document.getElementById('giftCalculatorContainer');
            container.innerHTML = '';
            container.appendChild(createGiftCalculator());
        });
        document.getElementById('amountInput').addEventListener('input', function() {
            let value = this.value.replace(/[^\d]/g, '');
            if (value) {
                this.value = formatNumberWithCommas(value);
            } else {
                this.value = '';
            }
            calcFee();
        });
        document.getElementById('typeSelect').addEventListener('change', calcFee);
        document.getElementById('bizSelect').addEventListener('change', calcFee);
        document.getElementById('addRateInput').addEventListener('input', function() {
            let value = this.value.replace(/[^\d.\-]/g, '');
            if (value) {
                this.value = value;
            } else {
                this.value = '';
            }
            calcFee();
        });
        document.getElementById('addAmountInput').addEventListener('input', function() {
            let value = this.value.replace(/[^\d]/g, '');
            if (value) {
                this.value = formatNumberWithCommas(value);
            } else {
                this.value = '';
            }
            calcFee();
        });
        document.getElementById('discountInput').addEventListener('input', function() {
            let value = this.value.replace(/[^\d]/g, '');
            if (value) {
                this.value = formatNumberWithCommas(value);
            } else {
                this.value = '';
            }
            calcFee();
        });
        document.getElementById('salaryCalcBtn').addEventListener('click', function() {
            showSection('salary');
        });
        // 초기화
        showSection('income');
    });

    // 스크린샷 모달 생성 및 기능 구현
    function showScreenshotModal() {
        let modal = document.getElementById('screenshotModal');
        if (!modal) {
            modal = document.createElement('div');
            modal.id = 'screenshotModal';
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100vw';
            modal.style.height = '100vh';
            modal.style.background = 'rgba(0,0,0,0.3)';
            modal.style.display = 'flex';
            modal.style.alignItems = 'center';
            modal.style.justifyContent = 'center';
            modal.style.zIndex = '3000';
            modal.innerHTML = `
                <div style="background:#fff;padding:30px 40px;border-radius:10px;box-shadow:0 4px 16px rgba(0,0,0,0.2);text-align:center;">
                    <h3 style="margin-bottom:20px;">저장 형식 선택</h3>
                    <button id="savePngBtn" style="margin:0 10px 0 0;padding:10px 20px;">PNG로 저장</button>
                    <button id="savePdfBtn" style="margin:0 0 0 10px;padding:10px 20px;">PDF로 저장</button>
                    <br><br>
                    <button id="closeScreenshotModal" style="margin-top:10px;">닫기</button>
                </div>
            `;
            document.body.appendChild(modal);
            document.getElementById('closeScreenshotModal').onclick = () => modal.remove();
            document.getElementById('savePngBtn').onclick = () => { saveScreenshot('png'); modal.remove(); };
            document.getElementById('savePdfBtn').onclick = () => { saveScreenshot('pdf'); modal.remove(); };
        }
    }
    async function saveScreenshot(type) {
        const section = document.querySelector('.main-content > div:not([style*="display: none"]) .calculator, .main-content > div:not([style*="display: none"]) .calculator-fee');
        if (!section) return alert('저장할 계산기 영역이 없습니다.');
        await html2canvas(section).then(canvas => {
            if (type === 'png') {
                const link = document.createElement('a');
                link.download = 'calculator.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
            } else if (type === 'pdf') {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new window.jspdf.jsPDF({ orientation: 'portrait', unit: 'px', format: [canvas.width, canvas.height] });
                pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
                pdf.save('calculator.pdf');
            }
        });
    }
    document.getElementById('screenshotButton').addEventListener('click', showScreenshotModal);
    </script>
</body>
</html>
