<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>세금 계산기</title>
    <!-- html2canvas 라이브러리 추가 -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2980b9;
            --background-color: #ecf0f1;
            --text-color: #34495e;
            --input-background: #fff;
            --result-background: #e8f4fd; /* 파스텔톤 하늘색 */
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 10px; /* 20px에서 10px로 줄임 */
            background-color: var(--background-color);
            color: var(--text-color);
            margin-left: 50px; /* 토글 버튼을 위한 공간 */
        }
        .calculator-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
        }
        .calculator {
            background-color: #fff;
            border-radius: 10px;
            padding: 15px; /* 20px에서 15px로 줄임 */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 350px;
            margin-bottom: 15px; /* 20px에서 15px로 줄임 */
        }
        h1 {
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 15px; /* 30px에서 15px로 줄임 */
            font-size: 24px; /* 제목 크기 줄임 */
        }
        label {
            display: block;
            margin: 10px 0 3px; /* 이전 설정 유지 */
            color: var(--secondary-color);
            font-weight: bold; /* 볼드 스타일 복원 */
        }
        input[type="text"], select {
            display: block;
            width: calc(100% - 20px);
            padding: 10px; /* 9px에서 10px로 증가 */
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            background-color: var(--input-background);
            color: var(--text-color);
            font-size: 14px; /* 13px에서 14px로 증가 */
            margin-bottom: 5px;
        }
        .result {
            margin-top: 15px; /* 20px에서 15px로 줄임 */
            padding: 10px; /* 15px에서 10px로 줄임 */
            background-color: var(--result-background);
            border-radius: 4px;
        }
        .result p {
            margin: 5px 0;
            font-weight: bold;
        }
        .buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 20px; /* 30px에서 20px로 줄임 */
        }
        button {
            padding: 10px 20px; /* 12px 24px에서 줄임 */
            border: none;
            border-radius: 4px;
            background-color: var(--primary-color);
            color: #fff;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.1s;
            font-size: 14px; /* 16px에서 14px로 줄임 */
            font-weight: bold;
        }
        button:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
        }
        button:active {
            transform: translateY(0);
        }
        @media (min-width: 768px) {
            .calculator {
                width: calc(50% - 20px);
            }
        }
        @media (min-width: 1024px) {
            .calculator {
                width: calc(25% - 15px); /* 33.33%에서 25%로 변경하여 한 줄에 4개 표시 */
            }
            #addCalculator, #resetAll {
                display: inline-block;
            }
        }
        @media (max-width: 1023px) {
            #addCalculator, #resetAll {
                display: none;
            }
        }
        .checkbox-container {
            display: flex;
            align-items: center;
            margin-top: 15px;
        }
        .checkbox-container input[type="checkbox"] {
            margin-right: 10px;
        }
        #calculatorType {
            margin-bottom: 20px;
            width: 100%;
            max-width: 350px;
        }
        /* 새로운 스타일 추가 */
        .calculator-type-buttons {
            display: flex;
            justify-content: center;
            margin-bottom: 15px; /* 20px에서 15px로 줄임 */
        }

        .calculator-type-button {
            padding: 8px 16px; /* 10px 20px에서 줄임 */
            margin: 0 10px;
            border: none;
            border-radius: 4px;
            background-color: var(--primary-color);
            color: #fff;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.1s;
            font-size: 14px; /* 16px에서 14px로 줄임 */
            font-weight: bold;
        }

        .calculator-type-button:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
        }

        .calculator-type-button:active {
            transform: translateY(0);
        }

        .calculator-type-button.active {
            background-color: var(--secondary-color);
        }

        /* 스크린샷 버튼 스타일 추가 */
        #screenshotButton {
            background-color: #27ae60;
            margin-left: 10px;
        }
        #screenshotButton:hover {
            background-color: #2ecc71;
        }
        .delete-button {
            background-color: #e74c3c;
            margin-top: 10px;
        }
        .delete-button:hover {
            background-color: #c0392b;
        }
        .total-tax {
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
            margin-top: 15px; /* 20px에서 15px로 줄임 */
            padding: 8px; /* 10px에서 8px로 줄임 */
            background-color: var(--result-background);
            border-radius: 4px;
        }
        
        /* 추가: 스크롤바 스타일 */
        body {
            max-height: 100vh;
            overflow-y: auto;
        }

        .result-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px; /* 8px에서 5px로 줄임 */
        }

        .result-label, .result-value {
            padding: 3px 0;
            font-weight: bold;
            font-size: 14px; /* 13px에서 14px로 증가 */
        }

        .gift-deduction-container {
            display: flex;
            flex-direction: column;
            gap: 5px; /* 10px에서 5px로 줄임 */
        }

        .gift-deduction-container select,
        .gift-deduction-container input {
            width: 100%;
            box-sizing: border-box;
            margin-bottom: 0; /* 하단 여백 제거 */
        }

        /* 직접 입력 칸의 스타일 수정 */
        .giftDeductionCustom {
            width: 100% !important;
            display: block;
            padding: 10px; /* 9px에서 10px로 증가 */
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            background-color: var(--input-background);
            color: var(--text-color);
            font-size: 14px; /* 13px에서 14px로 증가 */
            margin-top: 5px;
        }

        /* 전체적으로 위로 올리기 */
        .calculator-container {
            margin-top: -5px; /* -10px에서 -5px로 조정 */
        }

        /* 스크롤바 스타일 */
        body {
            scrollbar-width: thin;
            scrollbar-color: var(--secondary-color) var(--background-color);
        }

        body::-webkit-scrollbar {
            width: 8px;
        }

        body::-webkit-scrollbar-track {
            background: var(--background-color);
        }

        body::-webkit-scrollbar-thumb {
            background-color: var(--secondary-color);
            border-radius: 4px;
        }

        .history-panel {
            position: fixed;
            left: -250px;
            top: 0;
            width: 250px;
            height: 100%;
            background-color: #ffffff;
            transition: 0.3s;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }

        .history-panel.open {
            left: 0;
        }

        .toggle-history {
            position: fixed;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            writing-mode: vertical-rl;
            text-orientation: mixed;
            padding: 10px 5px;
            background-color: #3498db;
            color: white;
            border: none;
            cursor: pointer;
            z-index: 1001;
        }

        .history-content {
            padding: 20px;
        }

        .new-table-button {
            width: 100%;
            padding: 10px;
            margin-bottom: 20px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .history-item {
            margin-bottom: 10px;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-item h3 {
            margin: 0;
            flex-grow: 1;
            padding-right: 10px;
            font-size: 14px; /* 글자 크기를 줄임 */
        }

        .delete-history {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
        }

        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            background-color: #f9f9f9;
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
        }

        .dropdown:hover .dropdown-content {
            display: block;
        }

        .dropdown-content a {
            color: black;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
        }

        .dropdown-content a:hover {
            background-color: #f1f1f1;
        }

        body {
            margin-left: 50px; /* 토글 버튼을 위한 공간 */
        }

        .main-content {
            transition: margin-left 0.3s;
        }

        .history-panel {
            position: fixed;
            left: -250px;
            top: 0;
            width: 250px;
            height: 100%;
            background-color: #f1f1f1;
            transition: 0.3s;
            overflow-y: auto;
            z-index: 1000;
        }

        .history-panel.open {
            left: 0;
        }

        .toggle-history {
            position: fixed;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            writing-mode: vertical-rl;
            text-orientation: mixed;
            padding: 10px 5px;
            background-color: #3498db;
            color: white;
            border: none;
            cursor: pointer;
            z-index: 1001;
        }

        .history-content {
            padding: 20px;
        }

        .history-item {
            margin-bottom: 10px;
            padding: 10px;
            background-color: #fff;
            border-radius: 5px;
        }

        .history-item h3 {
            margin: 0;
            display: inline-block;
        }

        .delete-history {
            float: right;
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
        }

        .fee-center {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 300px;
        }
    </style>
</head>
<body>
    <div id="historyPanel" class="history-panel">
        <button id="toggleHistory" class="toggle-history">히스토리</button>
        <div class="history-content">
            <button id="newTable" class="new-table-button">새 테이블</button>
            <div id="historyItems"></div>
        </div>
    </div>
    
    <div class="main-content">
        <h1>세금 계산기</h1>
        <div class="calculator-type-buttons">
            <button id="incomeButton" class="calculator-type-button active">2024년 종합소득세 계산기</button>
            <button id="giftButton" class="calculator-type-button">증여세 계산기</button>
            <button id="feeButton" class="calculator-type-button">조정료 계산기</button>
            <button id="screenshotButton" class="calculator-type-button">스크린샷</button>
            <div class="dropdown">
                <button id="saveButton" class="calculator-type-button">저장</button>
                <div class="dropdown-content">
                    <a href="#" id="saveAsNew">다른 이름으로 저장</a>
                </div>
            </div>
        </div>
        <div id="incomeCalculatorSection">
            <div class="calculator-container" id="calculatorContainer"></div>
            <div class="total-tax" id="totalTax"></div>
            <div class="buttons">
                <button id="addCalculator">계산기 추가</button>
                <button id="resetAll">모두 초기화</button>
            </div>
        </div>
        <div id="feeCalculatorSection" class="fee-center" style="display:none;">
            <div class="calculator" id="feeCalculator">
                <h2>수수료 계산기</h2>
                <label for="typeSelect">구분</label>
                <select id="typeSelect">
                    <option value="개인">개인</option>
                    <option value="법인">법인</option>
                </select>
                <label for="bizSelect">업종</label>
                <select id="bizSelect">
                    <option value="서비스">서비스</option>
                    <option value="요식업">요식업</option>
                    <option value="도소매">도소매</option>
                    <option value="의료업">의료업</option>
                    <option value="신고대리">신고대리</option>
                </select>
                <label for="amountInput">매출액(원)</label>
                <input type="text" id="amountInput" placeholder="예: 1,000,000,000">
                <div id="baseFeePreview" style="margin:6px 0 10px 0; color:#2980b9; font-weight:bold;"></div>
                <label for="addRateInput">가산 비율(%)</label>
                <input type="text" id="addRateInput" placeholder="예: 10">
                <label for="addAmountInput">직접 가산 금액(원)</label>
                <input type="text" id="addAmountInput" placeholder="예: 200,000">
                <label for="discountInput">할인 금액(원)</label>
                <input type="text" id="discountInput" placeholder="예: 100,000">
                <button id="calcFeeBtn">계산</button>
                <div class="result" id="feeResult"></div>
            </div>
        </div>
        <div id="baseFeePreview" style="margin:6px 0 10px 0; color:#2980b9; font-weight:bold;"></div>
    </div>

    <script>
    // ------------------ 공통 유틸 ------------------
    function formatNumber(num) {
        return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }
    function unformatNumber(str) {
        return parseFloat((str || "0").toString().replace(/,/g, '')) || 0;
    }

    // ------------------ 종합소득세 계산기 ------------------
    function createIncomeCalculator() {
        const calculator = document.createElement('div');
        calculator.className = 'calculator';
        calculator.innerHTML = `
            <h2 contenteditable="true">2024년 종합소득세 계산</h2>
            <label>월 소득 (원):</label>
            <input type="text" class="monthlyIncome" placeholder="월 소득을 입력하세요">
            <label>곱할 개월 수:</label>
            <input type="text" class="monthMultiplier" value="12">
            <label>사업소득 (원):</label>
            <input type="text" class="businessIncome" placeholder="금액을 입력하세요">
            <label>소득공제 (원):</label>
            <input type="text" class="incomeDeduction" value="1,500,000">
            <div class="result">
                <div class="result-row">
                    <span class="result-label">과세표준:</span>
                    <span class="result-value"><span class="taxableIncome">0</span> 원</span>
                </div>
                <div class="result-row">
                    <span class="result-label">산출세액:</span>
                    <span class="result-value"><span class="calculatedTax">0</span> 원</span>
                </div>
                <div class="result-row">
                    <span class="result-label">한계세율:</span>
                    <span class="result-value"><span class="marginalTaxRate">0</span> %</span>
                </div>
            </div>
            <label>세액공제 (원):</label>
            <input type="text" class="taxCreditReduction" value="70,000">
            <div class="result">
                <div class="result-row">
                    <span class="result-label">최종 납부세액:</span>
                    <span class="result-value"><span class="finalTax">0</span> 원</span>
                </div>
                <div class="result-row">
                    <span class="result-label">최저한세:</span>
                    <span class="result-value"><span class="minimumTax">0</span> 원</span>
                </div>
                <div class="result-row">
                    <span class="result-label">추가 필요 세액공제:</span>
                    <span class="result-value"><span class="additionalTaxCredit">0</span> 원</span>
                </div>
            </div>
        `;
        calculator.querySelectorAll('input').forEach(input => {
            input.addEventListener('input', function() {
                updateInputFormat(this);
                if (this.classList.contains('monthlyIncome') || this.classList.contains('monthMultiplier')) {
                    calculateYearlyIncome(calculator);
                }
                calculateIncomeTax(calculator);
            });
        });
        return calculator;
    }
    function updateInputFormat(input) {
        let value = unformatNumber(input.value);
        input.value = formatNumber(value);
    }
    function calculateYearlyIncome(calculator) {
        const monthlyIncome = unformatNumber(calculator.querySelector('.monthlyIncome').value);
        const monthMultiplier = unformatNumber(calculator.querySelector('.monthMultiplier').value);
        const yearlyIncome = monthlyIncome * monthMultiplier;
        calculator.querySelector('.businessIncome').value = formatNumber(yearlyIncome);
    }
    function calculateIncomeTax(calculator) {
        const businessIncome = unformatNumber(calculator.querySelector('.businessIncome').value);
        const incomeDeduction = unformatNumber(calculator.querySelector('.incomeDeduction').value);
        const taxCreditReduction = unformatNumber(calculator.querySelector('.taxCreditReduction').value);
        const taxableIncome = Math.max(0, businessIncome - incomeDeduction);
        calculator.querySelector('.taxableIncome').innerText = formatNumber(taxableIncome);
        let calculatedTax = 0;
        if (taxableIncome <= 14000000) {
            calculatedTax = taxableIncome * 0.06;
        } else if (taxableIncome <= 50000000) {
            calculatedTax = 14000000 * 0.06 + (taxableIncome - 14000000) * 0.15;
        } else if (taxableIncome <= 88000000) {
            calculatedTax = 14000000 * 0.06 + 36000000 * 0.15 + (taxableIncome - 50000000) * 0.24;
        } else if (taxableIncome <= 150000000) {
            calculatedTax = 14000000 * 0.06 + 36000000 * 0.15 + 38000000 * 0.24 + (taxableIncome - 88000000) * 0.35;
        } else if (taxableIncome <= 300000000) {
            calculatedTax = 14000000 * 0.06 + 36000000 * 0.15 + 38000000 * 0.24 + 62000000 * 0.35 + (taxableIncome - 150000000) * 0.38;
        } else if (taxableIncome <= 500000000) {
            calculatedTax = 14000000 * 0.06 + 36000000 * 0.15 + 38000000 * 0.24 + 62000000 * 0.35 + 150000000 * 0.38 + (taxableIncome - 300000000) * 0.40;
        } else if (taxableIncome <= 1000000000) {
            calculatedTax = 14000000 * 0.06 + 36000000 * 0.15 + 38000000 * 0.24 + 62000000 * 0.35 + 150000000 * 0.38 + 200000000 * 0.40 + (taxableIncome - 500000000) * 0.42;
        } else {
            calculatedTax = 14000000 * 0.06 + 36000000 * 0.15 + 38000000 * 0.24 + 62000000 * 0.35 + 150000000 * 0.38 + 200000000 * 0.40 + 500000000 * 0.42 + (taxableIncome - 1000000000) * 0.45;
        }
        calculator.querySelector('.calculatedTax').innerText = formatNumber(Math.round(calculatedTax));
        const finalTax = Math.max(0, calculatedTax - taxCreditReduction);
        calculator.querySelector('.finalTax').innerText = formatNumber(Math.round(finalTax));
        let minimumTax = 0;
        if (calculatedTax <= 30000000) {
            minimumTax = calculatedTax * 0.35;
        } else {
            minimumTax = 30000000 * 0.35 + (calculatedTax - 30000000) * 0.45;
        }
        calculator.querySelector('.minimumTax').innerText = formatNumber(Math.round(minimumTax));
        const additionalTaxCredit = Math.max(0, finalTax - minimumTax);
        calculator.querySelector('.additionalTaxCredit').innerText = formatNumber(Math.round(additionalTaxCredit));
        let marginalTaxRate = 0;
        if (taxableIncome <= 14000000) marginalTaxRate = 6;
        else if (taxableIncome <= 50000000) marginalTaxRate = 15;
        else if (taxableIncome <= 88000000) marginalTaxRate = 24;
        else if (taxableIncome <= 150000000) marginalTaxRate = 35;
        else if (taxableIncome <= 300000000) marginalTaxRate = 38;
        else if (taxableIncome <= 500000000) marginalTaxRate = 40;
        else if (taxableIncome <= 1000000000) marginalTaxRate = 42;
        else marginalTaxRate = 45;
        calculator.querySelector('.marginalTaxRate').innerText = marginalTaxRate;
    }

    // ------------------ 증여세 계산기 ------------------
    function createGiftCalculator() {
        const calculator = document.createElement('div');
        calculator.className = 'calculator';
        const uniqueId = 'generationSkipping_' + Date.now() + Math.floor(Math.random()*1000);
        calculator.innerHTML = `
            <h2 contenteditable="true">증여세 계산</h2>
            <label>증여재산가액 (원):</label>
            <input type="text" class="giftAmount" placeholder="증여재산가액을 입력하세요">
            <label>사전증여재산 (원):</label>
            <input type="text" class="previousGift" placeholder="사전증여재산을 입력하세요">
            <label>증여재산공제 (원):</label>
            <div class="gift-deduction-container">
                <select class="giftDeduction">
                    <option value="10000000">10,000,000</option>
                    <option value="20000000">20,000,000</option>
                    <option value="50000000">50,000,000</option>
                    <option value="600000000">600,000,000</option>
                </select>
                <input type="text" class="giftDeductionCustom" placeholder="직접 입력">
            </div>
            <div class="checkbox-container">
                <input type="checkbox" id="${uniqueId}" class="generationSkipping">
                <label for="${uniqueId}">세대할증</label>
            </div>
            <div class="result">
                <div class="result-row">
                    <span class="result-label">증여세 과세표준:</span>
                    <span class="result-value"><span class="taxableGift">0</span> 원</span>
                </div>
                <div class="result-row">
                    <span class="result-label">산출세액:</span>
                    <span class="result-value"><span class="calculatedTax">0</span> 원</span>
                </div>
                <div class="result-row">
                    <span class="result-label">한계세율:</span>
                    <span class="result-value"><span class="marginalTaxRate">0</span> %</span>
                </div>
            </div>
            <div class="result">
                <div class="result-row">
                    <span class="result-label">신고세액공제:</span>
                    <span class="result-value"><span class="taxCreditReduction">0</span> 원</span>
                </div>
                <div class="result-row">
                    <span class="result-label">최종 납부세액:</span>
                    <span class="result-value"><span class="finalTax">0</span> 원</span>
                </div>
            </div>
            <button class="delete-button">삭제</button>
        `;
        calculator.querySelectorAll('input, select').forEach(input => {
            input.addEventListener('input', function() {
                if (this.type === 'text') updateInputFormat(this);
                calculateGiftTax(calculator);
            });
        });
        calculator.querySelector('.generationSkipping').addEventListener('change', function() {
            calculateGiftTax(calculator);
        });
        calculator.querySelector('label[for^="generationSkipping_"]').addEventListener('click', function() {
            setTimeout(() => calculateGiftTax(calculator), 0);
        });
        calculator.querySelector('.delete-button').addEventListener('click', function() {
            calculator.remove();
            updateTotalTax();
        });
        return calculator;
    }
    function calculateGiftTax(calculator) {
        const giftAmount = unformatNumber(calculator.querySelector('.giftAmount').value);
        const previousGift = unformatNumber(calculator.querySelector('.previousGift').value);
        let giftDeduction = unformatNumber(calculator.querySelector('.giftDeduction').value);
        const customDeduction = unformatNumber(calculator.querySelector('.giftDeductionCustom').value);
        const isGenerationSkipping = calculator.querySelector('.generationSkipping').checked;
        if (calculator.querySelector('.giftDeductionCustom').value !== '') {
            giftDeduction = customDeduction;
        }
        const taxableGift = Math.max(0, giftAmount + previousGift - giftDeduction);
        calculator.querySelector('.taxableGift').innerText = formatNumber(taxableGift);
        let calculatedTax = 0;
        if (taxableGift <= 100000000) {
            calculatedTax = taxableGift * 0.10;
        } else if (taxableGift <= 500000000) {
            calculatedTax = 10000000 + (taxableGift - 100000000) * 0.20;
        } else if (taxableGift <= 1000000000) {
            calculatedTax = 90000000 + (taxableGift - 500000000) * 0.30;
        } else if (taxableGift <= 3000000000) {
            calculatedTax = 240000000 + (taxableGift - 1000000000) * 0.40;
        } else {
            calculatedTax = 1040000000 + (taxableGift - 3000000000) * 0.50;
        }
        if (isGenerationSkipping) calculatedTax *= 1.3;
        calculator.querySelector('.calculatedTax').innerText = formatNumber(Math.round(calculatedTax));
        const taxCreditReduction = calculatedTax * 0.03;
        calculator.querySelector('.taxCreditReduction').innerText = formatNumber(Math.round(taxCreditReduction));
        const finalTax = Math.max(0, calculatedTax - taxCreditReduction);
        calculator.querySelector('.finalTax').innerText = formatNumber(Math.round(finalTax));
        let marginalTaxRate = 0;
        if (taxableGift <= 100000000) marginalTaxRate = 10;
        else if (taxableGift <= 500000000) marginalTaxRate = 20;
        else if (taxableGift <= 1000000000) marginalTaxRate = 30;
        else if (taxableGift <= 3000000000) marginalTaxRate = 40;
        else marginalTaxRate = 50;
        if (isGenerationSkipping) marginalTaxRate = Math.min(marginalTaxRate * 1.3, 50);
        calculator.querySelector('.marginalTaxRate').innerText = marginalTaxRate;
        updateTotalTax();
    }
    function updateTotalTax() {
        const calculators = document.querySelectorAll('.calculator-container .calculator');
        let totalTax = 0;
        calculators.forEach(calc => {
            const finalTaxElement = calc.querySelector('.finalTax');
            if (finalTaxElement) {
                totalTax += unformatNumber(finalTaxElement.innerText);
            }
        });
        document.getElementById('totalTax').innerText = `총 부담세액: ${formatNumber(Math.round(totalTax))} 원`;
    }

    // ------------------ 조정료(수수료) 계산기 ------------------
    let rateTable = {};
    async function loadRateTable() {
        try {
            const res = await fetch('rate_table.csv');
            const text = await res.text();
            const lines = text.split('\n').map(l => l.trim()).filter(l => l);
            let isHeader = true;
            for (let line of lines) {
                if (isHeader) { isHeader = false; continue; }
                const [구분, 업종, 수입금액, 요율, 베이스, 추가분, 합계] = line.split(',').map(x => (x||'').trim());
                if (!rateTable[구분]) rateTable[구분] = {};
                if (!rateTable[구분][업종]) rateTable[구분][업종] = [];
                rateTable[구분][업종].push({
                    수입금액: Number((수입금액||'').replace(/[^0-9]/g, '') || 0),
                    요율: parseFloat((요율||'').replace('%','')) || 0,
                    베이스: Number((베이스||'').replace(/[^0-9]/g, '') || 0),
                    추가분: Number((추가분||'').replace(/[^0-9]/g, '') || 0),
                    합계: Number((합계||'').replace(/[^0-9]/g, '') || 0)
                });
            }
            for (const type in rateTable) {
                for (const biz in rateTable[type]) {
                    rateTable[type][biz].sort((a, b) => a.수입금액 - b.수입금액);
                }
            }
        } catch (e) {
            document.getElementById('feeResult').innerHTML = '요율표.csv를 불러올 수 없습니다.';
        }
    }
    function formatNumberWithCommas(x) {
        if (typeof x === 'number') x = x.toString();
        return x.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }
    function calcFee() {
        const type = document.getElementById('typeSelect').value.trim();
        const biz = document.getElementById('bizSelect').value.trim();
        let amountRaw = document.getElementById('amountInput').value.replace(/[^\d]/g, '');
        let amount = Number(amountRaw);
        let addRate = parseFloat(document.getElementById('addRateInput').value.replace(/[^\d.\-]/g, '')) || 0;
        let addAmount = Number(document.getElementById('addAmountInput').value.replace(/[^\d]/g, '')) || 0;
        let discount = Number(document.getElementById('discountInput').value.replace(/[^\d]/g, '')) || 0;

        if (!rateTable[type] || !rateTable[type][biz]) {
            document.getElementById('feeResult').innerHTML = '요율표 정보가 없습니다.';
            return;
        }
        if (!amount) {
            document.getElementById('feeResult').innerHTML = '매출액을 입력하세요.';
            return;
        }
        let rows = rateTable[type][biz];
        let idx = 0;
        for (let i = 0; i < rows.length; i++) {
            if (amount >= rows[i].수입금액) idx = i;
            else break;
        }
        let row = rows[idx];
        let baseAmount = row.수입금액;
        let fee = row.베이스 + (amount - baseAmount) * (row.요율 / 100);
        fee = Math.round(fee/10)*10;
        let addRateFee = Math.round(fee * (addRate/100)/10)*10;
        let totalFee = fee + addRateFee + addAmount - discount;
        let penalty = Math.round(totalFee * 0.1/10)*10;
        let totalCharge = totalFee + penalty;
        const formula = `${row.베이스.toLocaleString()} + (${amount.toLocaleString()} - ${baseAmount.toLocaleString()}) × ${row.요율.toFixed(2)}%`;

        document.getElementById('feeResult').innerHTML =
            `<div>매출액 기준 수수료: <b>${fee.toLocaleString()}원</b></div>`+
            `<div>가산 비율 수수료: <b>${addRateFee.toLocaleString()}원</b></div>`+
            `<div>직접입력 수수료: <b>${addAmount.toLocaleString()}원</b></div>`+
            `<div>할인 금액: <b>${discount.toLocaleString()}원</b></div>`+
            `<div style='margin-top:8px;'>총 수수료 금액: <b>${totalFee.toLocaleString()}원</b></div>`+
            `<div>10% 가산세: <b>${penalty.toLocaleString()}원</b></div>`+
            `<div style='font-size:1.1em;margin-top:8px;'>총 청구금액: <b>${totalCharge.toLocaleString()}원</b></div>`+
            `<div style='font-size:13px;color:#888;margin-top:8px;'>계산식: (${formula}) + (${addRate}% 가산) + ${addAmount.toLocaleString()} - ${discount.toLocaleString()} + 10% 가산세</div>`;
    }

    // ------------------ 탭 전환 및 이벤트 ------------------
    function showSection(section) {
        document.getElementById('incomeCalculatorSection').style.display = (section === 'income' || section === 'gift') ? 'block' : 'none';
        document.getElementById('feeCalculatorSection').style.display = (section === 'fee') ? 'block' : 'none';
        document.getElementById('incomeButton').classList.toggle('active', section === 'income');
        document.getElementById('giftButton').classList.toggle('active', section === 'gift');
        document.getElementById('feeButton').classList.toggle('active', section === 'fee');
        if (section === 'income') {
            switchCalculatorType('income');
        } else if (section === 'gift') {
            switchCalculatorType('gift');
        }
    }
    function switchCalculatorType(type) {
        const container = document.getElementById('calculatorContainer');
        if (type === 'income') {
            container.innerHTML = '';
            container.appendChild(createIncomeCalculator());
            document.getElementById('totalTax').style.display = 'none';
        } else {
            container.innerHTML = '';
            container.appendChild(createGiftCalculator());
            document.getElementById('totalTax').style.display = 'block';
        }
        updateTotalTax();
    }
    function addCalculator() {
        const container = document.getElementById('calculatorContainer');
        const activeButton = document.querySelector('.calculator-type-button.active');
        const calculatorType = activeButton.id === 'incomeButton' ? 'income' : 'gift';
        if (calculatorType === 'income') {
            container.appendChild(createIncomeCalculator());
        } else {
            container.appendChild(createGiftCalculator());
            updateTotalTax();
        }
    }
    function resetAll() {
        const activeButton = document.querySelector('.calculator-type-button.active');
        const calculatorType = activeButton.id === 'incomeButton' ? 'income' : 'gift';
        switchCalculatorType(calculatorType);
    }

    function previewBaseFee() {
        const type = document.getElementById('typeSelect').value.trim();
        const biz = document.getElementById('bizSelect').value.trim();
        let amountRaw = document.getElementById('amountInput').value.replace(/[^\d]/g, '');
        let amount = Number(amountRaw);
        if (!rateTable[type] || !rateTable[type][biz] || !amount) {
            document.getElementById('baseFeePreview').innerText = '';
            return;
        }
        let rows = rateTable[type][biz];
        let idx = 0;
        for (let i = 0; i < rows.length; i++) {
            if (amount >= rows[i].수입금액) idx = i;
            else break;
        }
        let row = rows[idx];
        let baseAmount = row.수입금액;
        let fee = row.베이스 + (amount - baseAmount) * (row.요율 / 100);
        fee = Math.round(fee/10)*10;
        document.getElementById('baseFeePreview').innerText = `매출액 기준 수수료: ${fee.toLocaleString()}원`;
    }

    document.addEventListener('DOMContentLoaded', function() {
        loadRateTable();
        document.getElementById('incomeButton').addEventListener('click', () => showSection('income'));
        document.getElementById('giftButton').addEventListener('click', () => showSection('gift'));
        document.getElementById('feeButton').addEventListener('click', () => showSection('fee'));
        document.getElementById('addCalculator').addEventListener('click', addCalculator);
        document.getElementById('resetAll').addEventListener('click', resetAll);
        document.getElementById('calcFeeBtn').addEventListener('click', calcFee);
        document.getElementById('amountInput').addEventListener('input', function() {
            let value = this.value.replace(/[^\d]/g, '');
            if (value) {
                this.value = formatNumberWithCommas(value);
            } else {
                this.value = '';
            }
            calcFee();
        });
        document.getElementById('typeSelect').addEventListener('change', calcFee);
        document.getElementById('bizSelect').addEventListener('change', calcFee);
        document.getElementById('addRateInput').addEventListener('input', function() {
            let value = this.value.replace(/[^\d.\-]/g, '');
            if (value) {
                this.value = value;
            } else {
                this.value = '';
            }
            calcFee();
        });
        document.getElementById('addAmountInput').addEventListener('input', function() {
            let value = this.value.replace(/[^\d]/g, '');
            if (value) {
                this.value = formatNumberWithCommas(value);
            } else {
                this.value = '';
            }
            calcFee();
        });
        document.getElementById('discountInput').addEventListener('input', function() {
            let value = this.value.replace(/[^\d]/g, '');
            if (value) {
                this.value = formatNumberWithCommas(value);
            } else {
                this.value = '';
            }
            calcFee();
        });
        // 초기화
        showSection('income');
    });
    </script>
</body>
</html>
